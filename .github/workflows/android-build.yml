name: Android Build

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "30 4 * * *"
  workflow_dispatch:
    inputs:
      run_instrumentation_smoke:
        description: "Run emulator instrumentation smoke job"
        required: false
        default: false
        type: boolean
      include_flaky_tests:
        description: "Include @FlakyTest in instrumentation smoke (manual dispatch only)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-android-changes:
    runs-on: ubuntu-latest
    outputs:
      run_android_ci: ${{ steps.detect.outputs.run_android_ci }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Android-impacting changes
        id: detect
        shell: bash
        run: |
          run_android_ci="true"

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            base_sha="${{ github.event.pull_request.base.sha }}"
            head_sha="${{ github.event.pull_request.head.sha }}"
          elif [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            base_sha="${{ github.event.before }}"
            head_sha="${{ github.sha }}"
          else
            echo "run_android_ci=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -z "${base_sha}" || "${base_sha}" == "0000000000000000000000000000000000000000" ]]; then
            echo "run_android_ci=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          relevant_changes=$(
            git diff --name-only "${base_sha}" "${head_sha}" -- \
              app/ \
              build.gradle \
              build.gradle.kts \
              settings.gradle \
              settings.gradle.kts \
              gradle.properties \
              gradle/ \
              gradlew \
              gradlew.bat \
              scripts/adb/ \
              .github/workflows/android-build.yml
          )

          if [[ -z "${relevant_changes}" ]]; then
            run_android_ci="false"
          fi

          {
            echo "run_android_ci=${run_android_ci}"
            echo "base_sha=${base_sha}"
            echo "head_sha=${head_sha}"
          } >> "$GITHUB_OUTPUT"

          {
            echo "### Android CI change detection"
            echo
            echo "- run_android_ci=${run_android_ci}"
            if [[ -n "${relevant_changes}" ]]; then
              echo "- Relevant files changed:"
              echo '```'
              echo "${relevant_changes}"
              echo '```'
            else
              echo "- No Android-impacting file changes detected."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  build-test-lint:
    needs: detect-android-changes
    if: ${{ github.event_name != 'schedule' && !(github.event_name == 'workflow_dispatch' && github.event.inputs.run_instrumentation_smoke == 'true') && (github.event_name == 'workflow_dispatch' || needs.detect-android-changes.outputs.run_android_ci == 'true') }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept licenses and install SDK packages
        run: |
          yes | sdkmanager --licenses > /dev/null
          sdkmanager "platform-tools" "platforms;android-36" "build-tools;36.0.0"

      - name: Configure SDK path for Gradle
        run: |
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Ensure Gradle wrapper is executable
        run: chmod +x gradlew

      - name: Guard forbidden debug-signing property
        run: |
          if grep -Eq "^[[:space:]]*ergometer\\.release\\.debugSigning[[:space:]]*=[[:space:]]*true[[:space:]]*$" gradle.properties; then
            echo "Forbidden property detected: ergometer.release.debugSigning=true"
            exit 1
          fi

      - name: Decode release keystore (optional)
        env:
          ANDROID_RELEASE_KEYSTORE_B64: ${{ secrets.ANDROID_RELEASE_KEYSTORE_B64 }}
          ANDROID_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}
          ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
          ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
        run: |
          if [ -n "$ANDROID_RELEASE_KEYSTORE_B64" ] && \
             [ -n "$ANDROID_RELEASE_STORE_PASSWORD" ] && \
             [ -n "$ANDROID_RELEASE_KEY_ALIAS" ] && \
             [ -n "$ANDROID_RELEASE_KEY_PASSWORD" ]; then
            echo "$ANDROID_RELEASE_KEYSTORE_B64" | base64 --decode > "$RUNNER_TEMP/release-keystore.jks"
            echo "ERGOMETER_RELEASE_STORE_FILE=$RUNNER_TEMP/release-keystore.jks" >> "$GITHUB_ENV"
            echo "ERGOMETER_RELEASE_STORE_PASSWORD=$ANDROID_RELEASE_STORE_PASSWORD" >> "$GITHUB_ENV"
            echo "ERGOMETER_RELEASE_KEY_ALIAS=$ANDROID_RELEASE_KEY_ALIAS" >> "$GITHUB_ENV"
            echo "ERGOMETER_RELEASE_KEY_PASSWORD=$ANDROID_RELEASE_KEY_PASSWORD" >> "$GITHUB_ENV"
          elif [ -n "$ANDROID_RELEASE_KEYSTORE_B64" ] || \
               [ -n "$ANDROID_RELEASE_STORE_PASSWORD" ] || \
               [ -n "$ANDROID_RELEASE_KEY_ALIAS" ] || \
               [ -n "$ANDROID_RELEASE_KEY_PASSWORD" ]; then
            echo "Release signing secrets are partially configured."
            exit 1
          fi

      - name: Compile Debug Kotlin
        run: ./gradlew :app:compileDebugKotlin --no-daemon --stacktrace

      - name: Run Debug Unit Tests
        run: ./gradlew :app:testDebugUnitTest --no-daemon --stacktrace

      - name: Run Debug Lint
        run: ./gradlew :app:lintDebug --no-daemon --stacktrace

      - name: Assemble Release (minified)
        env:
          ERGOMETER_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}
          ERGOMETER_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
          ERGOMETER_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
        run: ./gradlew :app:assembleRelease --no-daemon --stacktrace -Pergometer.release.minify=true

      - name: Run Release Lint
        env:
          ERGOMETER_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}
          ERGOMETER_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
          ERGOMETER_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
        run: ./gradlew :app:lintRelease --no-daemon --stacktrace -Pergometer.release.minify=true

  android-instrumentation-smoke:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_instrumentation_smoke == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      SMOKE_TEST_CLASSES: com.example.ergometerapp.ui.MainActivityContentFlowTest,com.example.ergometerapp.MainActivityRecreationRotationTest
    concurrency:
      group: ${{ github.workflow }}-smoke-${{ github.ref_name || github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Ensure Gradle wrapper is executable
        run: chmod +x gradlew

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Resolve smoke policy
        id: smoke-policy
        shell: bash
        run: |
          include_flaky="false"
          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            include_flaky="true"
          elif [[ "${{ github.event.inputs.include_flaky_tests }}" == "true" ]]; then
            include_flaky="true"
          fi
          echo "include_flaky=${include_flaky}" >> "$GITHUB_OUTPUT"
          {
            echo "event_name=${GITHUB_EVENT_NAME}"
            echo "include_flaky=${include_flaky}"
          } > smoke-policy.txt

      - name: Run instrumentation smoke on emulator (include flaky)
        id: smoke-include-flaky
        if: ${{ steps.smoke-policy.outputs.include_flaky == 'true' }}
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: default
          arch: x86_64
          emulator-boot-timeout: 900
          disk-size: 4096M
          disable-animations: true
          emulator-options: -no-snapshot -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
          script: |
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
            ./gradlew :app:connectedDebugAndroidTest --no-daemon --stacktrace -Pandroid.testInstrumentationRunnerArguments.class="${SMOKE_TEST_CLASSES}"

      - name: Run instrumentation smoke on emulator (exclude flaky)
        if: ${{ steps.smoke-policy.outputs.include_flaky != 'true' }}
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: default
          arch: x86_64
          emulator-boot-timeout: 900
          disk-size: 4096M
          disable-animations: true
          emulator-options: -no-snapshot -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
          script: |
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
            ./gradlew :app:connectedDebugAndroidTest --no-daemon --stacktrace -Pandroid.testInstrumentationRunnerArguments.class="${SMOKE_TEST_CLASSES}" -Pandroid.testInstrumentationRunnerArguments.notAnnotation=androidx.test.filters.FlakyTest

      - name: Upload instrumentation smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-instrumentation-smoke-${{ github.run_id }}
          if-no-files-found: warn
          path: |
            smoke-policy.txt
            app/build/outputs/androidTest-results/connected/debug
            app/build/reports/androidTests/connected/debug
